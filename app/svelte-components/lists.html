<div class="main-visual">
  {{#if mainVisual}}
    <picture>
      <source
        type="image/webp"
        srcset="{{ srcset(data.basePath, mainVisual, 'webp') }}"
        sizes="100vw">
      <source
        type="image/jpeg"
        srcset="{{ srcset(data.basePath, mainVisual) }}"
        sizes="100vw">
      <img
        alt="Main image for '{{ mainVisualTitle }}'"
        src="{{ data.basePath }}/{{ mainVisual }}">
    </picture>
  {{/if}}
</div>

<div class="component component-list has-minor-navigation">
  <nav class="minor-navigation items-2 minor-nav-lists">
    {{#if data.groups && data.groups[0] }}
      <h1>{{ data.groups[0].title }}</h1>
    {{/if}}
  </nav>

  <article class="lists">
    <h1 class="heading-alternate">{{ data.title }}</h1>

    <div class="byline">
      {{#if fullByline(data)}}
        {{{ data.byline }}}
      {{else}}
        <strong>By {{ escapeHTML(data.byline) }}</strong> â€¢ Star Tribune
      {{/if}}
    </div>

    <div class="social-buttons social-buttons-gray">
      <a href="{{ facebookURL(data, content) }}" target="_blank" rel="noopener" class="facebook-button">
        <span class="sr-only">Share on Facebook</span>
      </a>
      <a href="{{ twitterURL(data, content) }}" target="_blank" rel="noopener" class="twitter-button">
        <span class="sr-only">Share on Twitter</span>
      </a>
      <a href="{{ emailURL(data, content) }}" target="_blank" rel="noopener" class="email-button">
        <span class="sr-only">Share via email</span>
      </a>
    </div>

    <div class="article-description">{{{ data.description }}}</div>

    <nav class="toggle-nav">
      {{#if utils && utils.hasGeolocate }}
        <ul class="cf">
          <li><a href="#/alpha" on:click="sortAlpha(event)" class="alphabetical {{ view === 'alpha' ? 'active' : '' }}">Alphabetical</a></li>
          <li>
            <a href="#/distance" on:click="sortDistance(event)" class="distance {{ view === 'distance' ? 'active' : '' }}">
              Near Me
              {{#if isGeolocating}}
                <i class="fa fa-spinner fa-spin"></i>
              {{/if}}
            </a>
          </li>
        </ul>
      {{/if}}
    </nav>

    {{#if data.items}}
      <div class="item-list">
        {{#each data.items as p @id}}
          <Item data="{{ p }}" utils="{{ utils }}" store="{{ store }}"
            display="list" view="{{ view }}" content="{{ content }}" />
        {{/each}}
      </div>
    {{else}}
      <div><em>This list should have items.</em></div>
    {{/if}}

    <div class="ad ad-placeholder">
      Ad Placeholder
    </div>
  </article>
</div>

<script>
import helpers from './common/helpers.js';
import methods from './common/methods.js';
import observe from '../observe.js';
import Item from './items.html';

export default {
  components: {
    Item
  },

  oncreate() {
    // In theory, we should be more specific and watch for data.items
    // changes, but that isn't actually going to change on the client.
    this.__dataInitialized = false;
    this.observe('data', n => {
      if (!n || this.__dataInitialized) {
        return;
      }
      this.__dataInitialized = true;

      if (n.mainImageLocal && !this.get('mainVisual')) {
        // When data is set, make default main visual
        this.set({ mainVisual: n.mainImageLocal });
      }

      // Observe list
      if (this.get('isBrowser')) {
        this.__itemObserver = observe({
          visibleThreshold: 0.5,
          elements: document.querySelectorAll('.item-list .component-item'),
          onObserve: _.throttle(_.bind(this.observeItem, this), 500)
        });
      }
    });

    // Watch for in view change.
    this.observe('inViewID', (n, o) => {
      if (n && n !== o) {
        let data = this.get('data');
        let item = _.find(data.items, { id: n });

        if (item) {
          data.items.forEach(i => {
            i.inView = i.id === n ? true : false;
          });
          this.set({ data: data });
        }
      }
    });
  },

  ondestroy() {
    let u = this.get('utils');
    if (u) {
      u.stopGeolocate();
    }
  },

  methods: {
    distance: methods.distance,
    geolocate: methods.geolocate,

    // Handle when an item is observed
    observeItem: function(id) {
      let data = this.get('data');
      let item = _.find(data.items, { id: id });

      // Mark as in view
      if (id) {
        this.set({ inViewID: id });
      }

      // Update image
      if (item && item.mainImageLocal) {
        this.set({
          mainVisual: item.mainImageLocal,
          mainVisualAlt: item.imageDescription
        });
      }
    },

    // Sort items by alpha
    sortAlpha: function(e) {
      if (e && e.preventDefault) {
        e.preventDefault();
      }

      this.set({ view: 'alpha' });
      let d = this.get('data');
      d.items = _.sortBy(d.items, i => {
        return i.title || i.name;
      });
      this.set({ data: d });
    },

    // Sort items by distance
    sortDistance: function(e) {
      if (e && e.preventDefault) {
        e.preventDefault();
      }

      // Since we depend on browers geolocation, check for browser
      if (!this.get('isBrowser')) {
        return;
      }

      this.set({ view: 'distance' });
      this.geolocate()
        .then(position => {
          let d = this.get('data');
          d.items = _.sortBy(d.items, i => {
            // Set distance
            if (i.latitude && i.longitude) {
              i.distance = this.distance(
                i.latitude,
                i.longitude,
                position.lat,
                position.lng
              );
            }

            return i.distance || 999999;
          });
          this.set({ data: d });
        })
        .catch(error => {
          // TODO: Do something in the interface about this
          // error.
          console.error(error);
        });
    }
  },

  helpers: {
    escapeHTML: helpers.escapeHTML,
    srcset: helpers.srcset,
    fullByline: helpers.fullByline,
    facebookURL: helpers.facebookURL,
    twitterURL: helpers.twitterURL,
    emailURL: helpers.emailURL
  },

  data() {
    return {
      isBrowser: typeof window !== undefined,
      view: 'alpha'
    };
  }
};
</script>
